<!--suppress HtmlRequiredLangAttribute, ThymeleafVariablesResolveInspection -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{/layout/layout}">

<div layout:fragment="content" sec:authorize="hasRole('ROLE_ADMIN')">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <input type="hidden" th:name="_csrf" th:value="${_csrf.token}"/>
    <div class="input-group container-xxl">
        <input style="border: 1px solid #b5cdf7" class="form-control me-2" type="search" placeholder="Search"
               aria-label="Search" name="searchKeyword" id="searchKeyword" th:value="${keyword}">
        <label for="searchOption"></label>
        <select class="form-select form-select-sm"
                name="searchOption" id="searchOption">
            <option value="all" th:selected="${option eq 'all'}">전체 찾기</option>
            <option value="id" th:selected="${option eq 'id'}">ID로 찾기</option>
            <option value="name" th:selected="${option eq 'name'}">이름으로 찾기</option>
            <option value="tel" th:selected="${option eq 'tel'}">연락처로 찾기</option>
            <option value="role" th:selected="${option eq 'role'}">권한으로 찾기</option>
        </select>
        <button class="btn btn-outline-success" type="submit" id="button_search" style="border-radius: 0em">검색</button>
    </div>
    
    <form method="get" id="searchForm">
        <input type="hidden" id="page" name="page" th:value="${memberPaging.number}">
        <input type="hidden" id="keyword" name="keyword" th:value="${keyword}">
        <input type="hidden" id="option" name="option" th:value="${option}">
    </form>
    
    <table class="table table-hover container-xxl">
        <thead>
        <tr class="table-info">
            <th scope="row">ID</th>
            <td>멤버이름</td>
            <td>전화번호</td>
            <td>등급</td>
            <td>가입일자</td>
        </tr>
        </thead>
        
        <tbody >
        <tr th:each="member, i : ${memberPaging}" th:class="memberPaging"
            class="table-light" data-bs-toggle="modal" th:attr="data-bs-target='#memberDetail_' + ${member.id}">
            <th th:text="${member.getId()}" scope="row">ID</th>
            <td th:text="${member.getName()}">멤버이름</td>
            <td th:text="${member.getTel()}">전화번호</td>
            <td th:text="${member.getRole()}">등급</td>
            <td th:text="${member.getIndate()}">가입일자</td>
        </tr>
        </tbody>
    </table>
    <div th:if="${!memberPaging.isEmpty()}">
        <ul class="pagination justify-content-center">
            <li th:classappend="${!memberPaging.hasPrevious()} ? 'disabled'" class="page-item">
                <a class="page-link" href="javascript:void(0)"
                   th:data-page="${(memberPaging.number) - 1}">&laquo;</a>
            </li>
            <li th:each="page : ${#numbers.sequence(0, memberPaging.getTotalPages() - 1)}"
                th:if="${page >= memberPaging.number - 10 and page <= memberPaging.number + 10}"
                th:classappend="${page == memberPaging.number} ? 'active'" class="page-item">
                <a th:text="${page + 1}" href="javascript:void(0)" th:data-page="${page}"
                   class="page-link"></a>
            </li>
            <li th:classappend="${!memberPaging.hasNext()} ? 'disabled'" class="page-item">
                <a class="page-link" href="javascript:void(0)"
                   th:data-page="${(memberPaging.number) + 1}">&raquo;</a>
            </li>
        </ul>
    </div>
    
    <!--페이지이동을 위한 js-->
    <!--    <script type="text/javascript">
            $(function () {
                $('.page-link').each(function () {
                    $(this).on('click', function () {
                        $('#page').val($(this).data('page'));
                        $('#searchForm').submit();
                    });
                });
            });
        </script>-->
    <script>
        $(function () {
            let header = $("meta[name='_csrf_header']").attr('content');
            let token = $("meta[name='_csrf']").attr('content');
            const buttonSearch = $('#button_search');
            const searchKeyword = $('#searchKeyword');
            const searchOption = $('#searchOption');

            /*console.log("토큰? ::: " + token);
            console.log("헤더 토큰? ::: " + header);*/

            searchKeyword.add(searchOption).on('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    buttonSearch.click();
                }
            });

            buttonSearch.on('click', function (event) {
                event.preventDefault();

                const page = 0;
                const keyword = searchKeyword.val();
                const option = searchOption.val();

                console.log("값 테스트1 :::: " + keyword);
                console.log("값 테스트2 :::: " + option);

                $.ajax({
                    type: 'GET',
                    url: "/management/member-Ajax",
/*                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(header, token);
                    },*/
                    dataType: "json",
                    /*data: JSON.stringify(params),*/
                    data:{page: page, keyword: keyword, option: option},
                    contentType: "application/json",
                    success: function (responseData) {
                        console.log('Ajax success');
                        const memberPaging = responseData.memberPaging;
                        $('memberPaging').replaceWith(memberPaging);
                    },
                    error: function () {
                        console.log('Ajax faill');
                        console.log("ajax val test " + searchKeyword.val());
                        console.log("ajax val test " + searchOption.val());
                    }
                });
            });
        });
    </script>
    
    <div th:each="member, i : ${memberPaging}" class="modal fade" th:id="'memberDetail_' + ${member.id}"
         tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel" th:text="|${member.getId()}님의 정보 수정|"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/management/member/modify}" th:object="${MMForm}" id="modifyForm" method="post">
                        <div th:replace="~{layout/formErrors::formErrorsFragment}"></div>
                        <div class="mb-3">
                            <fieldset disabled="">
                                <label for="recipient-id_view" class="col-form-label">ID(수정불가)</label>
                                <input th:name="id_view" type="text" class="form-control" id="recipient-id_view"
                                       th:value="${member.getId()}">
                            </fieldset>
                            <input th:field="*{id}" type="hidden" th:value="${member.getId()}">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-pwd" class="col-form-label">비밀번호 수정</label>
                            <label for="recipient-pwdModify"></label>
                            <input th:name="pwdModify" type="text" class="form-control"
                                   id="recipient-pwdModify" placeholder="공백으로 설정시 기존 비밀번호로 유지됩니다.">
                            <input type="hidden" th:field="*{pwd}" id="recipient-pwd" th:value="${member.getPwd()}">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">이름 수정</label>
                            <input th:field="*{name}" type="text" class="form-control" id="recipient-name"
                                   th:default="${member.getName()}"
                                   th:value="${member.getName()}">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-tel" class="col-form-label">연락처 수정</label>
                            <input th:name="tel" type="text" class="form-control is-invalid is-valid" id="recipient-tel"
                                   th:default="${member.getTel()}"
                                   th:value="${member.getTel()}">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-address" class="col-form-label">이메일 수정</label>
                            <input th:field="*{address}" type="text" class="form-control" id="recipient-address"
                                   th:default="${member.getAddress()}"
                                   th:value="${member.getAddress()}">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-role" class="col-form-label">권한 수정</label>
                            <select th:field="*{role}" type="text" class="form-control" id="recipient-role">
                                <option name="admin" value="Admin" th:selected="${member.getRole() == 'Admin'}">Admin
                                </option>
                                <option name="user" value="User"
                                        th:selected="${member.getRole() == 'User' || member.getRole() == null}">User
                                </option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary" id="button_modify">수정하기</button>
                        <button type="reset" class="btn btn-warning" id="button_reset">값 되돌리기</button>
                        <button th:data-uri="@{|/management/member/delete/${member.getId}|}"
                                type="button" class="call_delete_modal btn btn-outline-danger" id="call_delete_modal"
                                data-bs-toggle="modal" data-bs-target="#delete_modal">해당 유저 삭제
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="delete_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">정말로 삭제하시겠습니까?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="alert alert-dismissible alert-danger">
                    <strong>정말로 삭제하시겠습니까?</strong> 한번 더 다시 확인 해주세요!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">돌아가기</button>
                    <button type="button" class="button_delete btn btn-danger" data-uri="">네. 삭제하겠습니다.</button>
                </div>
            </div>
        </div>
    </div>
    
    <!--modifyForm을 위한 js-->
    <script>
        $(function () {
            const pwd = $('#recipient-pwd');
            const pwd_modify = $('#recipient-pwdModify');
            const btn_modify = $('#button_modify');

            btn_modify.on('click', function () {
                if (pwd_modify.length === 0) {
                    alert("비밀번호를 정확히 입력해주세요.");
                } else {
                    pwd.val(pwd_modify.val());
                    $('#modifyForm').submit();
                }
            });

            const btn_reset = $('#button_reset');
            btn_reset.on('click', function () {
                $('#modifyForm')[0].reset();
            });

            $('.call_delete_modal').each(function () {
                $(this).on('click', function () {
                    const uri = $(this).data('uri');
                    $('.button_delete').each(function () {
                        $(this).on('click', function () {
                            location.href = uri;
                        });
                    });
                });
            });
        });
    </script>
</div>

